services:
  multi-arch-build:
    image: golang:1.25.2-alpine
    working_dir: /project
    command:
      - /bin/sh
      - -c
      - |
        echo "üèóÔ∏è Building application for ${COMPOSE_PROJECT_NAME}"
        go mod download

        for OS_ARCH in "linux/amd64" "linux/arm64" "darwin/amd64" "darwin/arm64"; do
          OS=$${OS_ARCH%/*}
          ARCH=$${OS_ARCH#*/}
          echo "Building for $$OS/$$ARCH..."
          CGO_ENABLED=0 GOOS=$$OS GOARCH=$$ARCH go build \
              -ldflags="-s -w" \
              -o ./builds/vectormind-$$OS-$$ARCH main.go
          if [ $? -ne 0 ]; then
            echo "‚ùå Build failed for $$OS/$$ARCH"
            exit 1
          fi
        done

        echo "‚úÖ All builds succeeded"
        echo "üì¶ Artifacts generated at ./builds"
    volumes:
      - ./:/project
